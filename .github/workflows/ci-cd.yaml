name: Retail Store CI/CD Pipeline

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "src/**"

permissions:
  contents: write

env:
  AWS_REGION: us-east-1
  AWS_ACCOUNT_ID: 859092166102
  ECR_REGISTRY: 859092166102.dkr.ecr.us-east-1.amazonaws.com
  IMAGES_TO_KEEP: 3

# ======================================================
# DETECT CHANGED SERVICES
# ======================================================
jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      cart: ${{ steps.filter.outputs.cart }}
      catalog: ${{ steps.filter.outputs.catalog }}
      checkout: ${{ steps.filter.outputs.checkout }}
      orders: ${{ steps.filter.outputs.orders }}
      ui: ${{ steps.filter.outputs.ui }}
    steps:
      - uses: actions/checkout@v4

      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            cart: src/cart/**
            catalog: src/catalog/**
            checkout: src/checkout/**
            orders: src/orders/**
            ui: src/ui/**

  # ======================================================
  # COMMON DOCKER SETUP (BUILDx + AMD64)
  # ======================================================
  setup-docker:
    runs-on: ubuntu-latest
    steps:
      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

  # ======================================================
  # CART (JAVA)
  # ======================================================
  build-cart:
    needs: [detect-changes, setup-docker]
    if: needs.detect-changes.outputs.cart == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: temurin
          cache: maven

      - run: chmod +x mvnw && ./mvnw clean package -DskipTests
        working-directory: src/cart

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - uses: aws-actions/amazon-ecr-login@v2

      - run: |
          aws ecr describe-repositories --repository-name retail-store-cart || \
          aws ecr create-repository --repository-name retail-store-cart

          docker buildx build \
            --platform linux/amd64 \
            -t $ECR_REGISTRY/retail-store-cart:${{ github.sha }} \
            -t $ECR_REGISTRY/retail-store-cart:latest \
            --push .
        working-directory: src/cart

  # ======================================================
  # CATALOG (GO)
  # ======================================================
  build-catalog:
    needs: [detect-changes, setup-docker]
    if: needs.detect-changes.outputs.catalog == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.21"

      - run: go build -o main .
        working-directory: src/catalog

      - uses: aws-actions/configure-aws-credentials@v4
      - uses: aws-actions/amazon-ecr-login@v2

      - run: |
          aws ecr describe-repositories --repository-name retail-store-catalog || \
          aws ecr create-repository --repository-name retail-store-catalog

          docker buildx build \
            --platform linux/amd64 \
            -t $ECR_REGISTRY/retail-store-catalog:${{ github.sha }} \
            -t $ECR_REGISTRY/retail-store-catalog:latest \
            --push .
        working-directory: src/catalog

  # ======================================================
  # CHECKOUT (NODE)
  # ======================================================
  build-checkout:
    needs: [detect-changes, setup-docker]
    if: needs.detect-changes.outputs.checkout == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - run: npm install && npm run build --if-present
        working-directory: src/checkout

      - uses: aws-actions/configure-aws-credentials@v4
      - uses: aws-actions/amazon-ecr-login@v2

      - run: |
          aws ecr describe-repositories --repository-name retail-store-checkout || \
          aws ecr create-repository --repository-name retail-store-checkout

          docker buildx build \
            --platform linux/amd64 \
            -t $ECR_REGISTRY/retail-store-checkout:${{ github.sha }} \
            -t $ECR_REGISTRY/retail-store-checkout:latest \
            --push .
        working-directory: src/checkout

  # ======================================================
  # ORDERS (JAVA)
  # ======================================================
  build-orders:
    needs: [detect-changes, setup-docker]
    if: needs.detect-changes.outputs.orders == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: temurin

      - run: chmod +x mvnw && ./mvnw clean package -DskipTests
        working-directory: src/orders

      - uses: aws-actions/configure-aws-credentials@v4
      - uses: aws-actions/amazon-ecr-login@v2

      - run: |
          aws ecr describe-repositories --repository-name retail-store-orders || \
          aws ecr create-repository --repository-name retail-store-orders

          docker buildx build \
            --platform linux/amd64 \
            -t $ECR_REGISTRY/retail-store-orders:${{ github.sha }} \
            -t $ECR_REGISTRY/retail-store-orders:latest \
            --push .
        working-directory: src/orders

  # ======================================================
  # UI (JAVA)
  # ======================================================
  build-ui:
    needs: [detect-changes, setup-docker]
    if: needs.detect-changes.outputs.ui == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: temurin

      - run: chmod +x mvnw && ./mvnw clean package -DskipTests
        working-directory: src/ui

      - uses: aws-actions/configure-aws-credentials@v4
      - uses: aws-actions/amazon-ecr-login@v2

      - run: |
          aws ecr describe-repositories --repository-name retail-store-ui || \
          aws ecr create-repository --repository-name retail-store-ui

          docker buildx build \
            --platform linux/amd64 \
            -t $ECR_REGISTRY/retail-store-ui:${{ github.sha }} \
            -t $ECR_REGISTRY/retail-store-ui:latest \
            --push .
        working-directory: src/ui

  # ======================================================
  # CLEANUP ECR (KEEP LAST 3 IMAGES)
  # ======================================================
  cleanup-ecr:
    needs: [build-cart, build-catalog, build-checkout, build-orders, build-ui]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: aws-actions/configure-aws-credentials@v4

      - run: |
          for repo in \
            retail-store-cart \
            retail-store-catalog \
            retail-store-checkout \
            retail-store-orders \
            retail-store-ui
          do
            aws ecr describe-images \
              --repository-name $repo \
              --query 'sort_by(imageDetails,&imagePushedAt)[0:-3].imageDigest' \
              --output text | tr '\t' '\n' | \
              xargs -r -I {} aws ecr batch-delete-image \
                --repository-name $repo \
                --image-ids imageDigest={}
          done
