name: Retail Store CI/CD Pipeline

on:
  push:
    branches: [main]
    paths:
      - "src/**"
  pull_request:
    branches: [main]
    paths:
      - "src/**"

concurrency:
  group: helm-update-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

env:
  AWS_REGION: us-west-2
  ECR_REGISTRY: 859092166102.dkr.ecr.us-west-2.amazonaws.com
  IMAGES_TO_KEEP: 3

# =============================================================================
# DETECT CHANGES
# =============================================================================
jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      app: ${{ steps.changes.outputs.app }}
      cart: ${{ steps.changes.outputs.cart }}
      catalog: ${{ steps.changes.outputs.catalog }}
      checkout: ${{ steps.changes.outputs.checkout }}
      orders: ${{ steps.changes.outputs.orders }}
      ui: ${{ steps.changes.outputs.ui }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            app:      [ "src/app/**" ]
            cart:     [ "src/cart/**" ]
            catalog:  [ "src/catalog/**" ]
            checkout: [ "src/checkout/**" ]
            orders:   [ "src/orders/**" ]
            ui:       [ "src/ui/**" ]

# =============================================================================
# HELM UMBRELLA CHART LINT
# =============================================================================
  build-app:
    needs: detect-changes
    if: needs.detect-changes.outputs.app == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-helm@v4
      - run: helm dependency update
        working-directory: src/app/chart
      - run: helm lint .
        working-directory: src/app/chart

# =============================================================================
# CART (JAVA)
# =============================================================================
  build-cart:
    needs: detect-changes
    if: needs.detect-changes.outputs.cart == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: temurin
          cache: maven
      - run: chmod +x mvnw && ./mvnw clean package -DskipTests
        working-directory: src/cart
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      - uses: aws-actions/amazon-ecr-login@v2
      - run: |
          docker build -t $ECR_REGISTRY/retail-store-cart:${{ github.sha }} .
          docker tag $ECR_REGISTRY/retail-store-cart:${{ github.sha }} $ECR_REGISTRY/retail-store-cart:latest
          docker push --all-tags $ECR_REGISTRY/retail-store-cart
        working-directory: src/cart

# =============================================================================
# CATALOG (GO)
# =============================================================================
  build-catalog:
    needs: detect-changes
    if: needs.detect-changes.outputs.catalog == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.21"
      - run: go build -o main .
        working-directory: src/catalog
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      - uses: aws-actions/amazon-ecr-login@v2
      - run: |
          docker build -t $ECR_REGISTRY/retail-store-catalog:${{ github.sha }} .
          docker tag $ECR_REGISTRY/retail-store-catalog:${{ github.sha }} $ECR_REGISTRY/retail-store-catalog:latest
          docker push --all-tags $ECR_REGISTRY/retail-store-catalog
        working-directory: src/catalog

# =============================================================================
# CHECKOUT (NODE)
# =============================================================================
  build-checkout:
    needs: detect-changes
    if: needs.detect-changes.outputs.checkout == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - run: npm install && npm run build --if-present
        working-directory: src/checkout
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      - uses: aws-actions/amazon-ecr-login@v2
      - run: |
          docker build -t $ECR_REGISTRY/retail-store-checkout:${{ github.sha }} .
          docker tag $ECR_REGISTRY/retail-store-checkout:${{ github.sha }} $ECR_REGISTRY/retail-store-checkout:latest
          docker push --all-tags $ECR_REGISTRY/retail-store-checkout
        working-directory: src/checkout

# =============================================================================
# ORDERS + UI (JAVA)
# =============================================================================
  build-orders:
    needs: detect-changes
    if: needs.detect-changes.outputs.orders == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: temurin
          cache: maven
      - run: chmod +x mvnw && ./mvnw clean package -DskipTests
        working-directory: src/orders
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}
      - uses: aws-actions/amazon-ecr-login@v2
      - run: |
          docker build -t $ECR_REGISTRY/retail-store-orders:${{ github.sha }} .
          docker tag $ECR_REGISTRY/retail-store-orders:${{ github.sha }} $ECR_REGISTRY/retail-store-orders:latest
          docker push --all-tags $ECR_REGISTRY/retail-store-orders
        working-directory: src/orders

# =============================================================================
# CLEANUP OLD ECR IMAGES
# =============================================================================
  cleanup-ecr-images:
    needs:
      [build-cart, build-catalog, build-checkout, build-orders]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

# =============================================================================
# UPDATE HELM VALUES (GITOPS SAFE)
# =============================================================================
  update-helm-values:
    needs:
      [detect-changes, build-cart, build-catalog, build-checkout, build-orders]
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions@github.com"
          sed -i "s|tag: .*|tag: \"${{ github.sha }}\"|" src/*/chart/values.yaml
          git add src/*/chart/values.yaml
          git commit -m "chore: update image tags [skip ci]" || echo "No changes"
          git push

# =============================================================================
# SUMMARY
# =============================================================================
  summary:
    needs:
      [detect-changes, build-app, build-cart, build-catalog, build-checkout, build-orders, update-helm-values]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - run: |
          echo "## ðŸš€ Retail Store CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Region: us-west-2" >> $GITHUB_STEP_SUMMARY
          echo "- GitOps: Helm values updated" >> $GITHUB_STEP_SUMMARY
